#!/bin/bash
#
# Helper script to control netbird whilst playing nicely with Spacelift
#

[[ "$TRACE" ]] && set -o xtrace
set -o errexit
set -o nounset
set -o pipefail
set -o noclobber

usage() {
  echo "Usage: ${0} <up|down>"
}

if [[ -z ${TF_VAR_spacelift_workspace_root:-} ]]; then
  echo "spacebird: TF_VAR_spacelift_workspace_root not set but expected"
  usage
  exit 1
fi

# Check for authentication credentials - either OAuth or direct auth key
if [[ -z ${NB_SETUP_KEY:-} ]]; then
  echo "spacebird: NB_SETUP_KEY must be set"
  usage
  exit 1
fi

export NB_SETUP_KEY

if [[ -z ${1:-} ]]; then
  echo "spacebird: Action not set but expected"
  usage
  exit 1
fi

export NB_CONFIG="${TF_VAR_spacelift_workspace_root}/netbird.json"
readonly NB_CONFIG

export NB_DAEMON_ADDR="unix://${TF_VAR_spacelift_workspace_root}/netbird.sock"
readonly NB_DAEMON_ADDR

export NB_LOG_FILE="${TF_VAR_spacelift_workspace_root}/netbird.log"
readonly NB_LOG_FILE

ACTION="${1:-}"
readonly ACTION

export NB_EXTRA_DNS_LABELS="spacelift-$(hostname)"
readonly NB_EXTRA_DNS_LABELS

export NB_USE_NETSTACK_MODE=true
readonly NB_USE_NETSTACK_MODE

export NB_SOCKS5_LISTENER_PORT=1080
readonly NB_SOCKS5_LISTENER_PORT

export NB_FOREGROUND_MODE=true
readonly NB_FOREGROUND_MODE

if [[ -z ${NB_EXTRA_ARGS:-} ]]; then
  NB_EXTRA_ARGS="--log-level info"
fi
readonly NB_EXTRA_ARGS

if [[ "${ACTION}" = "up" ]]; then
  echo "spacebird: Bringing netbird up"
  # shellcheck disable=SC2086
  nohup netbird up ${NB_EXTRA_ARGS}
  echo "spacebird: Netbird up"
elif [[ "${ACTION}" = "down" ]]; then
  echo "spacebird: Taking netbird down"
  # Stopping netbird brings the ephemeral node down cleanly
  pkill netbird
  echo "spacebird: Netbird down"
else
  echo "spacebird: Unknown action ${ACTION}"
  usage
  exit 1
fi
